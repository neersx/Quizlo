<div class="questionnaire-container">
  <!-- Timer -->
  <div class="timer" [class.warning]="timeRemaining() < 300">
    ‚è∞ {{ formattedTime() }}
  </div>

  <!-- Main Container -->
  <div class="container">
    <!-- Header -->
    <div *ngIf="!isLoadingTest" class="header">
      <h1>{{ testData.title }}</h1>
      <p>{{ testData.examName }}</p>

      <div class="test-info">
        <div class="info-card">
          <h3>Language</h3>
          <p>{{ testDetails?.language }}</p>
        </div>
        <div class="info-card">
          <h3>Duration</h3>
          <p>{{ testDetails?.duration }}</p>
        </div>
        <div class="info-card">
          <h3>Total Marks</h3>
          <p>{{ testDetails?.totalMarks }}</p>
        </div>
        <div class="info-card">
          <h3>Difficulty</h3>
          <p>Medium</p>
        </div>
      </div>

      <div *ngIf="result && testData.questions" class="test-result">
        <div class="result-card">
          <h3>Questions Answered</h3>
          <p>{{ answeredQuestionsCount() }} / {{ testData.questions.length }}</p>
        </div>
        <div class="result-card">
          <h3>Your Test Score</h3>
          <p>{{ result.score }}/{{ this.testData.totalMarks }}</p>
        </div>
        <div class="result-card">
          <h3>Completed In Duration</h3>
          <p>{{ result.correctAnswers }} Minutes</p>
        </div>
        <div *ngIf="result.percentage" class="result-card">
          <h3>Percentage</h3>
          <p>{{ result.percentage.toFixed(2) }}%</p>
        </div>
      </div>

      <!-- Progress Bar -->
      <div *ngIf="testData && testData.questions" class="progress-container">
        <div class="progress-info">
          <span>Progress: {{ answeredQuestionsCount() }}/{{ testData.questions.length }}</span>
          <span>{{ progressPercentage() | number:'1.0-0' }}%</span>
        </div>
        <div class="progress-bar">
          <div class="progress-fill" [style.width.%]="progressPercentage()"></div>
        </div>
      </div>
    </div>

    <div *ngIf="isLoadingTest" class="header text-center">
      <h4 style="text-align: center;">Loading Test Details...</h4>
      <app-test-skeleton-loader 
          [variant]="currentVariant" [displayFooter]="false"  [displayProgress]="true" [totalQuestions]="0">
        </app-test-skeleton-loader>
    </div>

    <!-- Test Content -->
    <div class="test-content" *ngIf="!isTestSubmitted() && !isLoadingQuestions">
      <!-- Question Navigation -->
      <div class="question-navigation">
        <button *ngFor="let question of testData?.questions; let i = index" class="nav-btn"
          [class.active]="currentQuestionIndex() === i" [class.answered]="answers()['question_' + question.id]"
          (click)="goToQuestion(i)">
          {{ i + 1 }}
        </button>
      </div>

      <!-- Current Question -->
      <div class="question-container" *ngIf="currentQuestion as question">
        <div class="question-card">
          <div class="question-header">
            <span class="question-number">Question {{ question.questionNo }}</span>
            <span class="difficulty-badge" [ngClass]="getDifficultyClass(question.difficulty)">
              {{ question.difficulty }}
            </span>
            <span *ngIf="question.marks" class="question-marks">
              {{ question.marks }} Mark{{ question.marks > 1 ? 's' : '' }}
            </span>
          </div>

          <!-- Multiple Select Indicator -->
          <div class="multiple-select-note" *ngIf="question?.isMultipleSelect">
            üìù Multiple selections allowed for this question
          </div>

          <div class="question-text">{{ question?.questionText }}</div>

          <!-- Options -->
          <div *ngIf="question.options" class="options-container">
            <label *ngFor="let option of question.options; let i = index" class="option form-check-label"
              [class.selected]="isOptionSelected(question.id ?? -1, charFromCode(i))">

              <!-- Single Select (Radio) -->
              <div class="form-check" *ngIf="!question.isMultipleSelect">
                <input type="radio" class="form-check-input" [name]="'question_' + question.id"
                  [value]="charFromCode(i)" [checked]="isOptionSelected(question.id ?? -1, charFromCode(i))"
                  (change)="onSingleOptionSelect(question.id ?? -1, charFromCode(i))">
                <span class="option-text">{{ option }}</span>
              </div>
              <!-- Multiple Select (Checkbox) -->
              <div class="form-check" *ngIf="question?.isMultipleSelect">
                <input type="checkbox" class="form-check-input"
                  [name]="'question_' + question?.id + '_' + charFromCode(i)" [value]="charFromCode(i)"
                  [checked]="isOptionSelected(question?.id ?? -1, charFromCode(i))"
                  (change)="onMultipleOptionSelect(question?.id ?? -1, charFromCode(i), $event)">
                <span class="option-text">{{ option }}</span>
              </div>
            </label>
          </div>


          <!-- Navigation Buttons -->
          <div class="question-navigation-buttons">
            <button class="nav-button prev-btn" (click)="previousQuestion()" [disabled]="currentQuestionIndex() === 0">
              ‚Üê Previous
            </button>

            <button *ngIf="testData && testData.questions && testData.questions.length" class="nav-button next-btn"
              (click)="nextQuestion()" [disabled]="currentQuestionIndex() === (testData.questions.length) - 1">
              Next ‚Üí
            </button>
          </div>
        </div>
      </div>

      <app-grid-loader *ngIf="submittingTest" [rowCount]="1">
      </app-grid-loader>

      <!-- Submit Section -->
      <div *ngIf="testData && testData.questions" class="row submit-container">
        <div class="submit-card">
          <div class="submit-info">
            <p>Answered: {{ answeredQuestionsCount() }}/ {{ testData.questions?.length }} questions </p>
            <p>Time Remaining: {{ formattedTime() }}</p>
          </div>
          
          <button *ngIf="testData && testData.questions" [disabled]="answeredQuestionsCount() < testData.questions.length" class="submit-btn" (click)="submitTest()">
            Submit Test
          </button>
  
        </div>

      </div>
    </div>

    <div *ngIf="isLoadingQuestions"  class="loader-container">
      <h5 style="text-align: center;">Ai is generating your questions...</h5>
      <app-test-skeleton-loader 
        [displayHeader]="false"
        [displayFooter]="true"
        [totalQuestions]="testData.totalQuestions > 0 ? testData.totalQuestions : 20">
      </app-test-skeleton-loader>
</div>

  </div>

  <!-- Test Completed -->
  <div *ngIf="testData && testData.questions && isTestSubmitted()" class="row submit-container">
    <div class="submit-card">
      <h2 style="color: dimgrey;">üéâ Test Completed Successfully!</h2>
      <!-- <button class="reset-btn" (click)="resetTest()">Take Test Again</button> -->
      <button class="submit-btn" (click)="exitTest()" [disabled]="answeredQuestionsCount() === 0">
        Exit Test
      </button>
    </div>
  </div>
</div>


